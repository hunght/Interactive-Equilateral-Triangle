<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Interactive Equilateral Triangle with Correct Height Line</title>
    <style>
      body {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        height: 100vh;
        margin: 0;
        font-family: Arial, sans-serif;
        background-color: #f0f0f0;
      }
      .triangle-container {
        width: 300px;
        height: 260px;
        position: relative;
        cursor: none;
        border: 1px solid #ccc;
        overflow: hidden;
      }
      .triangle {
        width: 100%;
        height: 100%;
        background-color: yellow;
      }
      #dot {
        position: absolute;
        width: 10px;
        height: 10px;
        background-color: red;
        border-radius: 50%;
        transform: translate(-50%, -50%);
        pointer-events: none;
      }
      #coordinates {
        margin-top: 20px;
        padding: 10px;
        background-color: white;
        border: 1px solid #ccc;
      }
    </style>
  </head>
  <body>
    <div class="triangle-container" id="triangle-container">
      <svg class="triangle" viewBox="0 0 1 0.866" id="triangle-svg">
        <polygon
          points="0,0.866 0.5,0 1,0.866"
          fill="#e0e0e0"
          stroke="#333"
          stroke-width="0.005"
        />
        <text x="0.5" y="0.05" font-size="0.05" text-anchor="middle">1,0</text>
        <text x="0.05" y="0.85" font-size="0.05" text-anchor="start">0,0</text>
        <text x="0.95" y="0.85" font-size="0.05" text-anchor="end">0,1</text>
        <line
          id="height-line"
          x1="0"
          y1="0"
          x2="0"
          y2="0"
          stroke="blue"
          stroke-width="0.002"
          stroke-dasharray="0.01"
        />
        <text
          id="height-label"
          x="0"
          y="0"
          font-size="0.04"
          text-anchor="start"
          fill="blue"
        ></text>
      </svg>
      <div id="dot"></div>
    </div>
    <div id="coordinates">0.33, 0.33, 0.33</div>

    <script>
      const container = document.getElementById('triangle-container');
      const dot = document.getElementById('dot');
      const coordinatesDisplay = document.getElementById('coordinates');
      const heightLine = document.getElementById('height-line');
      const heightLabel = document.getElementById('height-label');

      // Define the constant for triangle height
      const TRIANGLE_HEIGHT = 0.866;

      function constrainToTriangle(x, y) {
        console.log('Before constraint:', x, y);
        if (y > Math.sqrt(3) * (0.5 - Math.abs(x - 0.5))) {
          y = Math.sqrt(3) * (0.5 - Math.abs(x - 0.5));
        }
        if (x < 0) x = 0;
        if (x > 1) x = 1;
        if (y < 0) y = 0;
        if (y > TRIANGLE_HEIGHT) y = TRIANGLE_HEIGHT;
        console.log('After constraint:', x, y);
        return [x, y];
      }

      function getBarycentricCoordinates(x, y) {
        const a = 1 - x - y / Math.sqrt(3);
        const b = x - y / Math.sqrt(3);
        const c = (2 * y) / Math.sqrt(3);
        return [a, b, c].map((v) => Math.max(0, Math.min(1, v)));
      }

      function updateHeightLine(x, y) {
        heightLine.setAttribute('x1', x);
        heightLine.setAttribute('y1', TRIANGLE_HEIGHT - y);
        heightLine.setAttribute('x2', x);
        heightLine.setAttribute('y2', TRIANGLE_HEIGHT);

        // Calculate the height of the line
        const height = y;

        // Update the height label position and text
        heightLabel.setAttribute('x', x + 0.01); // Slight offset for readability
        heightLabel.setAttribute('y', TRIANGLE_HEIGHT - 0.02); // Slight offset from bottom
        heightLabel.textContent = x.toFixed(2);

        console.log(`Height line: ${height.toFixed(3)}, x: ${x.toFixed(2)}`);
      }

      function updateDotAndCoordinates(x, y) {
        console.log('Input coordinates:', x, y);
        [x, y] = constrainToTriangle(x, y);
        console.log('Constrained coordinates:', x, y);

        const containerRect = container.getBoundingClientRect();
        console.log(
          'Container dimensions:',
          containerRect.width,
          containerRect.height
        );

        // Calculate the actual triangle height
        const trianglePixelHeight = (containerRect.width * Math.sqrt(3)) / 2;

        // Calculate dot position based on triangle geometry
        const dotX = x * containerRect.width;
        const dotY =
          containerRect.height - (y / TRIANGLE_HEIGHT) * trianglePixelHeight;

        console.log('Dot position:', dotX, dotY);

        dot.style.left = `${dotX}px`;
        dot.style.top = `${dotY}px`;
        updateHeightLine(x, y);

        const [a, b, c] = getBarycentricCoordinates(x, y);
        coordinatesDisplay.textContent = `${a.toFixed(2)}, ${b.toFixed(
          2
        )}, ${c.toFixed(2)}`;
      }

      container.addEventListener('mousemove', (e) => {
        const rect = container.getBoundingClientRect();
        let x = (e.clientX - rect.left) / rect.width;
        let y = 1 - (e.clientY - rect.top) / rect.height;
        console.log('Mouse event coordinates:', x, y);

        updateDotAndCoordinates(x, y);
      });

      // Test case
      console.log('Test case: (0.5, TRIANGLE_HEIGHT)');
      updateDotAndCoordinates(0.5, TRIANGLE_HEIGHT);

      // Initialize dot at the center of the triangle
      updateDotAndCoordinates(0.5, TRIANGLE_HEIGHT / 2);
    </script>
  </body>
</html>
